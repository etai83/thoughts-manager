{"version":3,"sources":["../../src/components/facets.ts"],"sourcesContent":["import { createError } from '../errors.js'\nimport type {\n  AnyOrama,\n  FacetResult,\n  FacetSorting,\n  FacetsParams,\n  NumberFacetDefinition,\n  SearchableValue,\n  StringFacetDefinition,\n  TokenScore\n} from '../types.js'\nimport { getNested } from '../utils.js'\n\ntype FacetValue = string | boolean | number\n\nfunction sortAsc(a: [string, number], b: [string, number]) {\n  return a[1] - b[1]\n}\n\nfunction sortDesc(a: [string, number], b: [string, number]) {\n  return b[1] - a[1]\n}\n\nfunction sortingPredicateBuilder(order: FacetSorting = 'desc') {\n  return order.toLowerCase() === 'asc' ? sortAsc : sortDesc\n}\n\nexport async function getFacets<T extends AnyOrama>(\n  orama: T,\n  results: TokenScore[],\n  facetsConfig: FacetsParams<T>\n): Promise<FacetResult> {\n  const facets: FacetResult = {}\n  const allIDs = results.map(([id]) => id)\n  const allDocs = await orama.documentsStore.getMultiple(orama.data.docs, allIDs)\n  const facetKeys = Object.keys(facetsConfig!)\n\n  const properties = await orama.index.getSearchablePropertiesWithTypes(orama.data.index)\n\n  for (const facet of facetKeys) {\n    let values\n\n    // Hack to guarantee the same order of ranges as specified by the user\n    // TODO: Revisit this once components land\n    if (properties[facet] === 'number') {\n      const { ranges } = facetsConfig[facet] as NumberFacetDefinition\n      const rangesLength = ranges.length\n      const tmp: [string, number][] = Array.from({ length: rangesLength })\n      for (let i = 0; i < rangesLength; i++) {\n        const range = ranges[i]\n        tmp[i] = [`${range.from}-${range.to}`, 0]\n      }\n      values = Object.fromEntries(tmp)\n    }\n\n    facets[facet] = {\n      count: 0,\n      values: values ?? {}\n    }\n  }\n\n  const allDocsLength = allDocs.length\n  for (let i = 0; i < allDocsLength; i++) {\n    const doc = allDocs[i]\n\n    for (const facet of facetKeys) {\n      const facetValue = facet.includes('.')\n        ? (await getNested<string>(doc!, facet))!\n        : (doc![facet] as SearchableValue)\n\n      const propertyType = properties[facet]\n      const facetValues = facets[facet].values\n      switch (propertyType) {\n        case 'number': {\n          const ranges = (facetsConfig[facet] as NumberFacetDefinition).ranges\n          calculateNumberFacetBuilder(ranges, facetValues)(facetValue as number)\n          break\n        }\n        case 'number[]': {\n          const alreadyInsertedValues = new Set<string>()\n          const ranges = (facetsConfig[facet] as NumberFacetDefinition).ranges\n          const calculateNumberFacet = calculateNumberFacetBuilder(ranges, facetValues, alreadyInsertedValues)\n          for (const v of facetValue as Array<number>) {\n            calculateNumberFacet(v)\n          }\n          break\n        }\n        case 'boolean':\n        case 'enum':\n        case 'string': {\n          calculateBooleanStringOrEnumFacetBuilder(facetValues, propertyType)(facetValue as FacetValue)\n          break\n        }\n        case 'boolean[]':\n        case 'enum[]':\n        case 'string[]': {\n          const alreadyInsertedValues = new Set<string>()\n          const innerType = propertyType === 'boolean[]' ? 'boolean' : 'string'\n          const calculateBooleanStringOrEnumFacet = calculateBooleanStringOrEnumFacetBuilder(\n            facetValues,\n            innerType,\n            alreadyInsertedValues\n          )\n          for (const v of facetValue as Array<FacetValue>) {\n            calculateBooleanStringOrEnumFacet(v)\n          }\n          break\n        }\n        default:\n          throw createError('FACET_NOT_SUPPORTED', propertyType)\n      }\n    }\n  }\n\n  // TODO: We are looping again with the same previous keys, should we creat a single loop instead?\n  for (const facet of facetKeys) {\n    const currentFacet = facets[facet]\n    // Count the number of values for each facet\n    currentFacet.count = Object.keys(currentFacet.values).length\n    // Sort only string-based facets\n    if (properties[facet] === 'string') {\n      const stringFacetDefinition = facetsConfig[facet] as StringFacetDefinition\n      const sortingPredicate = sortingPredicateBuilder(stringFacetDefinition.sort)\n\n      currentFacet.values = Object.fromEntries(\n        Object.entries(currentFacet.values)\n          .sort(sortingPredicate)\n          .slice(stringFacetDefinition.offset ?? 0, stringFacetDefinition.limit ?? 10)\n      )\n    }\n  }\n\n  return facets\n}\n\nfunction calculateNumberFacetBuilder(\n  ranges: NumberFacetDefinition['ranges'],\n  values: Record<string, number>,\n  alreadyInsertedValues?: Set<string>\n) {\n  return (facetValue: number) => {\n    for (const range of ranges) {\n      const value = `${range.from}-${range.to}`\n      if (alreadyInsertedValues?.has(value)) {\n        continue\n      }\n\n      if (facetValue >= range.from && facetValue <= range.to) {\n        if (values[value] === undefined) {\n          values[value] = 1\n        } else {\n          values[value]++\n\n          alreadyInsertedValues?.add(value)\n        }\n      }\n    }\n  }\n}\n\nfunction calculateBooleanStringOrEnumFacetBuilder(\n  values: Record<string, number>,\n  propertyType: 'string' | 'boolean' | 'enum',\n  alreadyInsertedValues?: Set<string>\n) {\n  const defaultValue = propertyType === 'boolean' ? 'false' : ''\n  return (facetValue: FacetValue) => {\n    // String or boolean based facets\n    const value = facetValue?.toString() ?? defaultValue\n    if (alreadyInsertedValues?.has(value)) {\n      return\n    }\n    values[value] = (values[value] ?? 0) + 1\n    alreadyInsertedValues?.add(value)\n  }\n}\n"],"names":["createError","getNested","sortAsc","a","b","sortDesc","sortingPredicateBuilder","order","toLowerCase","getFacets","orama","results","facetsConfig","facets","allIDs","map","id","allDocs","documentsStore","getMultiple","data","docs","facetKeys","Object","keys","properties","index","getSearchablePropertiesWithTypes","facet","values","ranges","rangesLength","length","tmp","Array","from","i","range","to","fromEntries","count","allDocsLength","doc","facetValue","includes","propertyType","facetValues","calculateNumberFacetBuilder","alreadyInsertedValues","Set","calculateNumberFacet","v","calculateBooleanStringOrEnumFacetBuilder","innerType","calculateBooleanStringOrEnumFacet","currentFacet","stringFacetDefinition","sortingPredicate","sort","entries","slice","offset","limit","value","has","undefined","add","defaultValue","toString"],"mappings":"AAAA,SAASA,WAAW,QAAQ,eAAc;AAW1C,SAASC,SAAS,QAAQ,cAAa;AAIvC,SAASC,QAAQC,CAAmB,EAAEC,CAAmB,EAAE;IACzD,OAAOD,CAAC,CAAC,EAAE,GAAGC,CAAC,CAAC,EAAE;AACpB;AAEA,SAASC,SAASF,CAAmB,EAAEC,CAAmB,EAAE;IAC1D,OAAOA,CAAC,CAAC,EAAE,GAAGD,CAAC,CAAC,EAAE;AACpB;AAEA,SAASG,wBAAwBC,QAAsB,MAAM,EAAE;IAC7D,OAAOA,MAAMC,WAAW,OAAO,QAAQN,UAAUG,QAAQ;AAC3D;AAEA,OAAO,eAAeI,UACpBC,KAAQ,EACRC,OAAqB,EACrBC,YAA6B,EACP;IACtB,MAAMC,SAAsB,CAAC;IAC7B,MAAMC,SAASH,QAAQI,GAAG,CAAC,CAAC,CAACC,GAAG,GAAKA;IACrC,MAAMC,UAAU,MAAMP,MAAMQ,cAAc,CAACC,WAAW,CAACT,MAAMU,IAAI,CAACC,IAAI,EAAEP;IACxE,MAAMQ,YAAYC,OAAOC,IAAI,CAACZ;IAE9B,MAAMa,aAAa,MAAMf,MAAMgB,KAAK,CAACC,gCAAgC,CAACjB,MAAMU,IAAI,CAACM,KAAK;IAEtF,KAAK,MAAME,SAASN,UAAW;QAC7B,IAAIO;QAEJ,sEAAsE;QACtE,0CAA0C;QAC1C,IAAIJ,UAAU,CAACG,MAAM,KAAK,UAAU;YAClC,MAAM,EAAEE,OAAM,EAAE,GAAGlB,YAAY,CAACgB,MAAM;YACtC,MAAMG,eAAeD,OAAOE,MAAM;YAClC,MAAMC,MAA0BC,MAAMC,IAAI,CAAC;gBAAEH,QAAQD;YAAa;YAClE,IAAK,IAAIK,IAAI,GAAGA,IAAIL,cAAcK,IAAK;gBACrC,MAAMC,QAAQP,MAAM,CAACM,EAAE;gBACvBH,GAAG,CAACG,EAAE,GAAG;oBAAC,CAAC,EAAEC,MAAMF,IAAI,CAAC,CAAC,EAAEE,MAAMC,EAAE,CAAC,CAAC;oBAAE;iBAAE;YAC3C;YACAT,SAASN,OAAOgB,WAAW,CAACN;QAC9B,CAAC;QAEDpB,MAAM,CAACe,MAAM,GAAG;YACdY,OAAO;YACPX,QAAQA,UAAU,CAAC;QACrB;IACF;IAEA,MAAMY,gBAAgBxB,QAAQe,MAAM;IACpC,IAAK,IAAII,IAAI,GAAGA,IAAIK,eAAeL,IAAK;QACtC,MAAMM,MAAMzB,OAAO,CAACmB,EAAE;QAEtB,KAAK,MAAMR,SAASN,UAAW;YAC7B,MAAMqB,aAAaf,MAAMgB,QAAQ,CAAC,OAC7B,MAAM3C,UAAkByC,KAAMd,SAC9Bc,GAAI,CAACd,MAAM,AAAoB;YAEpC,MAAMiB,eAAepB,UAAU,CAACG,MAAM;YACtC,MAAMkB,cAAcjC,MAAM,CAACe,MAAM,CAACC,MAAM;YACxC,OAAQgB;gBACN,KAAK;oBAAU;wBACb,MAAMf,SAAS,AAAClB,YAAY,CAACgB,MAAM,CAA2BE,MAAM;wBACpEiB,4BAA4BjB,QAAQgB,aAAaH;wBACjD,KAAK;oBACP;gBACA,KAAK;oBAAY;wBACf,MAAMK,wBAAwB,IAAIC;wBAClC,MAAMnB,SAAS,AAAClB,YAAY,CAACgB,MAAM,CAA2BE,MAAM;wBACpE,MAAMoB,uBAAuBH,4BAA4BjB,QAAQgB,aAAaE;wBAC9E,KAAK,MAAMG,KAAKR,WAA6B;4BAC3CO,qBAAqBC;wBACvB;wBACA,KAAK;oBACP;gBACA,KAAK;gBACL,KAAK;gBACL,KAAK;oBAAU;wBACbC,yCAAyCN,aAAaD,cAAcF;wBACpE,KAAK;oBACP;gBACA,KAAK;gBACL,KAAK;gBACL,KAAK;oBAAY;wBACf,MAAMK,wBAAwB,IAAIC;wBAClC,MAAMI,YAAYR,iBAAiB,cAAc,YAAY,QAAQ;wBACrE,MAAMS,oCAAoCF,yCACxCN,aACAO,WACAL;wBAEF,KAAK,MAAMG,KAAKR,WAAiC;4BAC/CW,kCAAkCH;wBACpC;wBACA,KAAK;oBACP;gBACA;oBACE,MAAMnD,YAAY,uBAAuB6C,cAAa;YAC1D;QACF;IACF;IAEA,iGAAiG;IACjG,KAAK,MAAMjB,SAASN,UAAW;QAC7B,MAAMiC,eAAe1C,MAAM,CAACe,MAAM;QAClC,4CAA4C;QAC5C2B,aAAaf,KAAK,GAAGjB,OAAOC,IAAI,CAAC+B,aAAa1B,MAAM,EAAEG,MAAM;QAC5D,gCAAgC;QAChC,IAAIP,UAAU,CAACG,MAAM,KAAK,UAAU;YAClC,MAAM4B,wBAAwB5C,YAAY,CAACgB,MAAM;YACjD,MAAM6B,mBAAmBnD,wBAAwBkD,sBAAsBE,IAAI;YAE3EH,aAAa1B,MAAM,GAAGN,OAAOgB,WAAW,CACtChB,OAAOoC,OAAO,CAACJ,aAAa1B,MAAM,EAC/B6B,IAAI,CAACD,kBACLG,KAAK,CAACJ,sBAAsBK,MAAM,IAAI,GAAGL,sBAAsBM,KAAK,IAAI;QAE/E,CAAC;IACH;IAEA,OAAOjD;AACT,CAAC;AAED,SAASkC,4BACPjB,MAAuC,EACvCD,MAA8B,EAC9BmB,qBAAmC,EACnC;IACA,OAAO,CAACL,aAAuB;QAC7B,KAAK,MAAMN,SAASP,OAAQ;YAC1B,MAAMiC,QAAQ,CAAC,EAAE1B,MAAMF,IAAI,CAAC,CAAC,EAAEE,MAAMC,EAAE,CAAC,CAAC;YACzC,IAAIU,kCAAAA,mCAAAA,KAAAA,IAAAA,sBAAuBgB,GAAG,CAACD,QAAQ;gBACrC,QAAQ;YACV,CAAC;YAED,IAAIpB,cAAcN,MAAMF,IAAI,IAAIQ,cAAcN,MAAMC,EAAE,EAAE;gBACtD,IAAIT,MAAM,CAACkC,MAAM,KAAKE,WAAW;oBAC/BpC,MAAM,CAACkC,MAAM,GAAG;gBAClB,OAAO;oBACLlC,MAAM,CAACkC,MAAM;oBAEbf,kCAAAA,mCAAAA,KAAAA,IAAAA,sBAAuBkB,GAAG,CAACH;gBAC7B,CAAC;YACH,CAAC;QACH;IACF;AACF;AAEA,SAASX,yCACPvB,MAA8B,EAC9BgB,YAA2C,EAC3CG,qBAAmC,EACnC;IACA,MAAMmB,eAAetB,iBAAiB,YAAY,UAAU,EAAE;IAC9D,OAAO,CAACF,aAA2B;QACjC,iCAAiC;QACjC,MAAMoB,QAAQpB,CAAAA,uBAAAA,wBAAAA,KAAAA,IAAAA,WAAYyB,QAAQ,OAAMD;QACxC,IAAInB,kCAAAA,mCAAAA,KAAAA,IAAAA,sBAAuBgB,GAAG,CAACD,QAAQ;YACrC;QACF,CAAC;QACDlC,MAAM,CAACkC,MAAM,GAAG,AAAClC,CAAAA,MAAM,CAACkC,MAAM,IAAI,CAAA,IAAK;QACvCf,kCAAAA,mCAAAA,KAAAA,IAAAA,sBAAuBkB,GAAG,CAACH;IAC7B;AACF"}