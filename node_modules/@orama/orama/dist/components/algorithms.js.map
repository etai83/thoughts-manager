{"version":3,"sources":["../../src/components/algorithms.ts"],"sourcesContent":["import { createError } from '../errors.js'\nimport { TokenScore, BM25Params } from '../types.js'\nimport { InternalDocumentID } from './internal-document-id-store.js'\n\nexport function prioritizeTokenScores(\n  arrays: TokenScore[][],\n  boost: number,\n  threshold = 0,\n  keywordsCount: number\n): TokenScore[] {\n  if (boost === 0) {\n    throw createError('INVALID_BOOST_VALUE')\n  }\n\n  const tokenScoresMap = new Map<InternalDocumentID, [number, number]>()\n\n  const mapsLength = arrays.length\n  for (let i = 0; i < mapsLength; i++) {\n    const arr = arrays[i]\n\n    const entriesLength = arr.length\n    for (let j = 0; j < entriesLength; j++) {\n      const [token, score] = arr[j]\n      const boostScore = score * boost\n      const oldScore = tokenScoresMap.get(token)?.[0]\n\n      if (oldScore !== undefined) {\n        tokenScoresMap.set(token, [oldScore * 1.5 + boostScore, (tokenScoresMap?.get(token)?.[1] || 0) + 1])\n      } else {\n        tokenScoresMap.set(token, [boostScore, 1])\n      }\n    }\n  }\n\n  const tokenScores: TokenScore[] = []\n\n  for (const tokenScoreEntry of tokenScoresMap.entries()) {\n    tokenScores.push([tokenScoreEntry[0], tokenScoreEntry[1][0]])\n  }\n\n  const results = tokenScores.sort((a, b) => b[1] - a[1])\n\n  // If threshold is 1, it means we will return all the results with at least one search term,\n  // prioritizig the ones that contains more search terms (fuzzy match)\n  if (threshold === 1) {\n    return results\n  }\n\n  // Prepare keywords count tracking for threshold handling\n  const allResults = results.length\n  const tokenScoreWithKeywordsCount: [InternalDocumentID, number, number][] = []\n\n  for (const tokenScoreEntry of tokenScoresMap.entries()) {\n    tokenScoreWithKeywordsCount.push([tokenScoreEntry[0], tokenScoreEntry[1][0], tokenScoreEntry[1][1]])\n  }\n\n  // Find the index of the last result with all keywords.\n  // Order the documents by the number of keywords they contain, and then by the score.\n  const keywordsPerToken = tokenScoreWithKeywordsCount.sort((a, b) => {\n    // Compare by the third element, higher numbers first\n    if (a[2] > b[2]) return -1\n    if (a[2] < b[2]) return 1\n\n    // If the third elements are equal, compare by the second element, higher numbers first\n    if (a[1] > b[1]) return -1\n    if (a[1] < b[1]) return 1\n\n    // If both the second and third elements are equal, consider the elements equal\n    return 0\n  })\n\n  let lastTokenWithAllKeywords: number | undefined = undefined\n  for (let i = 0; i < allResults; i++) {\n    if (keywordsPerToken[i][2] === keywordsCount) {\n      lastTokenWithAllKeywords = i\n    } else {\n      break\n    }\n  }\n\n  // If no results had all the keywords, either bail out earlier or normalize\n  if (typeof lastTokenWithAllKeywords === 'undefined') {\n    if (threshold === 0) {\n      return []\n    }\n\n    lastTokenWithAllKeywords = 0\n  }\n\n  const keywordsPerTokenLength = keywordsPerToken.length\n  const resultsWithIdAndScore: [number, number][] = new Array(keywordsPerTokenLength)\n  for (let i = 0; i < keywordsPerTokenLength; i++) {\n    resultsWithIdAndScore[i] = [keywordsPerToken[i][0], keywordsPerToken[i][1]]\n  }\n\n  // If threshold is 0, it means we will only return all the results that contains ALL the search terms (exact match)\n  if (threshold === 0) {\n    return resultsWithIdAndScore.slice(0, lastTokenWithAllKeywords + 1)\n  }\n\n  // If the threshold is between 0 and 1, we will return all the results that contains at least the threshold of search terms\n  // For example, if threshold is 0.5, we will return all the results that contains at least 50% of the search terms\n  // (fuzzy match with a minimum threshold)\n  const thresholdLength =\n    lastTokenWithAllKeywords + Math.ceil((threshold * 100 * (allResults - lastTokenWithAllKeywords)) / 100)\n\n  return resultsWithIdAndScore.slice(0, allResults + thresholdLength)\n}\n\nexport function BM25(\n  tf: number,\n  matchingCount: number,\n  docsCount: number,\n  fieldLength: number,\n  averageFieldLength: number,\n  { k, b, d }: Required<BM25Params>\n) {\n  const idf = Math.log(1 + (docsCount - matchingCount + 0.5) / (matchingCount + 0.5))\n  return (idf * (d + tf * (k + 1))) / (tf + k * (1 - b + (b * fieldLength) / averageFieldLength))\n}\n"],"names":["createError","prioritizeTokenScores","arrays","boost","threshold","keywordsCount","tokenScoresMap","Map","mapsLength","length","i","arr","entriesLength","j","token","score","boostScore","oldScore","get","undefined","set","tokenScores","tokenScoreEntry","entries","push","results","sort","a","b","allResults","tokenScoreWithKeywordsCount","keywordsPerToken","lastTokenWithAllKeywords","keywordsPerTokenLength","resultsWithIdAndScore","Array","slice","thresholdLength","Math","ceil","BM25","tf","matchingCount","docsCount","fieldLength","averageFieldLength","k","d","idf","log"],"mappings":"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"}