{"version":3,"sources":["../../src/methods/search-vector.ts"],"sourcesContent":["import type { AnyOrama, Results, SearchParamsVector, TypedDocument, Result } from '../types.js'\nimport type { InternalDocumentID } from '../components/internal-document-id-store.js'\nimport { createSearchContext } from './search.js'\nimport { getNanosecondsTime, formatNanoseconds } from '../utils.js'\nimport { getFacets } from '../components/facets.js'\nimport { createError } from '../errors.js'\nimport { findSimilarVectors } from '../components/cosine-similarity.js'\nimport { intersectFilteredIDs } from '../components/filters.js'\nimport { getGroups } from '../components/groups.js'\nimport { getInternalDocumentId, getDocumentIdFromInternalId } from '../components/internal-document-id-store.js'\nimport { Language } from '../index.js'\nimport { runBeforeSearch, runAfterSearch } from '../components/hooks.js'\n\nexport async function searchVector<T extends AnyOrama, ResultDocument = TypedDocument<T>>(\n  orama: T,\n  params: SearchParamsVector<T, ResultDocument>,\n  language: Language = 'english'\n): Promise<Results<ResultDocument>> {\n  const timeStart = await getNanosecondsTime()\n\n  if (orama.beforeSearch) {\n    await runBeforeSearch(orama.beforeSearch, orama, params, language)\n  }\n\n  const { vector } = params\n\n  if (vector && (!('value' in vector) || !('property' in vector))) {\n    throw createError('INVALID_VECTOR_INPUT', Object.keys(vector).join(', '))\n  }\n\n  const { limit = 10, offset = 0, includeVectors = false } = params\n  const vectorIndex = orama.data.index.vectorIndexes[vector!.property]\n  const vectorSize = vectorIndex.size\n  const vectors = vectorIndex.vectors\n  const shouldCalculateFacets = params.facets && Object.keys(params.facets).length > 0\n  const hasFilters = Object.keys(params.where ?? {}).length > 0\n  const { index, docs: oramaDocs } = orama.data\n\n  if (vector?.value.length !== vectorSize) {\n    // eslint-disable-next-line\n    throw createError('INVALID_INPUT_VECTOR', vector?.property!, vectorSize, vector?.value.length!)\n  }\n\n  if (!(vector instanceof Float32Array)) {\n    vector.value = new Float32Array(vector.value)\n  }\n\n  let results = findSimilarVectors(vector.value as Float32Array, vectors, vectorSize, params.similarity).map(\n    ([id, score]) => [getInternalDocumentId(orama.internalDocumentIDStore, id), score]\n  ) as [number, number][]\n\n  let propertiesToSearch = orama.caches['propertiesToSearch'] as string[]\n\n  if (!propertiesToSearch) {\n    const propertiesToSearchWithTypes = await orama.index.getSearchablePropertiesWithTypes(index)\n\n    propertiesToSearch = await orama.index.getSearchableProperties(index)\n    propertiesToSearch = propertiesToSearch.filter((prop: string) =>\n      propertiesToSearchWithTypes[prop].startsWith('string')\n    )\n\n    orama.caches['propertiesToSearch'] = propertiesToSearch\n  }\n\n  const tokens = []\n\n  const context = await createSearchContext(\n    orama.tokenizer,\n    orama.index,\n    orama.documentsStore,\n    language,\n    params,\n    propertiesToSearch,\n    tokens,\n    await orama.documentsStore.count(oramaDocs),\n    timeStart\n  )\n\n  let whereFiltersIDs: InternalDocumentID[] = []\n\n  if (hasFilters) {\n    whereFiltersIDs = await orama.index.searchByWhereClause(context, index, params.where!)\n    results = intersectFilteredIDs(whereFiltersIDs, results)\n  }\n\n  let facetsResults: any = []\n\n  if (shouldCalculateFacets) {\n    // Populate facets if needed\n    const facets = await getFacets(orama, results, params.facets!)\n    facetsResults = facets\n  }\n\n  const docs: Result<ResultDocument>[] = Array.from({ length: limit })\n\n  for (let i = 0; i < limit; i++) {\n    const result = results[i + offset]\n    if (!result) {\n      break\n    }\n\n    const doc = orama.data.docs.docs[result[0]]\n\n    if (doc) {\n      if (!includeVectors) {\n        doc[vector.property] = null\n      }\n\n      const newDoc: Result<ResultDocument> = {\n        id: getDocumentIdFromInternalId(orama.internalDocumentIDStore, result[0]),\n        score: result[1],\n        document: doc\n      }\n      docs[i] = newDoc\n    }\n  }\n\n  let groups: any = []\n\n  if (params.groupBy) {\n    groups = await getGroups<T, ResultDocument>(orama, results, params.groupBy)\n  }\n\n  if (orama.afterSearch) {\n    await runAfterSearch(orama.afterSearch, orama, params, language, results as any)\n  }\n\n  const timeEnd = await getNanosecondsTime()\n  const elapsedTime = timeEnd - timeStart\n\n  return {\n    count: results.length,\n    hits: docs.filter(Boolean),\n    elapsed: {\n      raw: Number(elapsedTime),\n      formatted: await formatNanoseconds(elapsedTime)\n    },\n    ...(facetsResults ? { facets: facetsResults } : {}),\n    ...(groups ? { groups } : {})\n  }\n}\n"],"names":["createSearchContext","getNanosecondsTime","formatNanoseconds","getFacets","createError","findSimilarVectors","intersectFilteredIDs","getGroups","getInternalDocumentId","getDocumentIdFromInternalId","runBeforeSearch","runAfterSearch","searchVector","orama","params","language","timeStart","beforeSearch","vector","Object","keys","join","limit","offset","includeVectors","vectorIndex","data","index","vectorIndexes","property","vectorSize","size","vectors","shouldCalculateFacets","facets","length","hasFilters","where","docs","oramaDocs","value","Float32Array","results","similarity","map","id","score","internalDocumentIDStore","propertiesToSearch","caches","propertiesToSearchWithTypes","getSearchablePropertiesWithTypes","getSearchableProperties","filter","prop","startsWith","tokens","context","tokenizer","documentsStore","count","whereFiltersIDs","searchByWhereClause","facetsResults","Array","from","i","result","doc","newDoc","document","groups","groupBy","afterSearch","timeEnd","elapsedTime","hits","Boolean","elapsed","raw","Number","formatted"],"mappings":"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"}