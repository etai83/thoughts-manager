{"version":3,"sources":["../../src/methods/search-fulltext.ts"],"sourcesContent":["import { prioritizeTokenScores } from '../components/algorithms.js'\nimport { getFacets } from '../components/facets.js'\nimport { intersectFilteredIDs } from '../components/filters.js'\nimport { getGroups } from '../components/groups.js'\nimport { runAfterSearch, runBeforeSearch } from '../components/hooks.js'\nimport type { InternalDocumentID } from '../components/internal-document-id-store.js'\nimport { getInternalDocumentId } from '../components/internal-document-id-store.js'\nimport { createError } from '../errors.js'\nimport type {\n  AnyOrama,\n  CustomSorterFunctionItem,\n  ElapsedTime,\n  Results,\n  SearchParamsFullText,\n  TokenScore,\n  TypedDocument\n} from '../types.js'\nimport { getNanosecondsTime, removeVectorsFromHits, safeArrayPush, sortTokenScorePredicate } from '../utils.js'\nimport { createSearchContext, defaultBM25Params, fetchDocuments, fetchDocumentsWithDistinct } from './search.js'\n\nexport async function fullTextSearch<T extends AnyOrama, ResultDocument = TypedDocument<T>>(\n  orama: T,\n  params: SearchParamsFullText<T, ResultDocument>,\n  language?: string\n): Promise<Results<ResultDocument>> {\n  const timeStart = await getNanosecondsTime()\n\n  if (orama.beforeSearch) {\n    await runBeforeSearch(orama.beforeSearch, orama, params, language)\n  }\n\n  params.relevance = Object.assign(defaultBM25Params, params.relevance ?? {})\n\n  const vectorProperties = Object.keys(orama.data.index.vectorIndexes)\n\n  const shouldCalculateFacets = params.facets && Object.keys(params.facets).length > 0\n  const { limit = 10, offset = 0, term, properties, threshold = 0, distinctOn, includeVectors = false } = params\n  const isPreflight = params.preflight === true\n\n  const { index, docs } = orama.data\n  const tokens = await orama.tokenizer.tokenize(term ?? '', language)\n\n  // Get searchable string properties\n  let propertiesToSearch = orama.caches['propertiesToSearch'] as string[]\n  if (!propertiesToSearch) {\n    const propertiesToSearchWithTypes = await orama.index.getSearchablePropertiesWithTypes(index)\n\n    propertiesToSearch = await orama.index.getSearchableProperties(index)\n    propertiesToSearch = propertiesToSearch.filter((prop: string) =>\n      propertiesToSearchWithTypes[prop].startsWith('string')\n    )\n\n    orama.caches['propertiesToSearch'] = propertiesToSearch\n  }\n\n  if (properties && properties !== '*') {\n    for (const prop of properties) {\n      if (!propertiesToSearch.includes(prop as string)) {\n        throw createError('UNKNOWN_INDEX', prop as string, propertiesToSearch.join(', '))\n      }\n    }\n\n    propertiesToSearch = propertiesToSearch.filter((prop: string) => (properties as string[]).includes(prop))\n  }\n\n  // Create the search context and the results\n  const context = await createSearchContext(\n    orama.tokenizer,\n    orama.index,\n    orama.documentsStore,\n    language,\n    params,\n    propertiesToSearch,\n    tokens,\n    await orama.documentsStore.count(docs),\n    timeStart\n  )\n\n  // If filters are enabled, we need to get the IDs of the documents that match the filters.\n  const hasFilters = Object.keys(params.where ?? {}).length > 0\n  let whereFiltersIDs: InternalDocumentID[] = []\n\n  if (hasFilters) {\n    whereFiltersIDs = await orama.index.searchByWhereClause(context, index, params.where!)\n  }\n\n  const tokensLength = tokens.length\n\n  if (tokensLength || properties?.length) {\n    // Now it's time to loop over all the indices and get the documents IDs for every single term\n    const indexesLength = propertiesToSearch.length\n    for (let i = 0; i < indexesLength; i++) {\n      const prop = propertiesToSearch[i]\n      const docIds = context.indexMap[prop]\n\n      if (tokensLength !== 0) {\n        for (let j = 0; j < tokensLength; j++) {\n          const term = tokens[j]\n\n          // Lookup\n          const scoreList = await orama.index.search(context, index, prop, term)\n\n          safeArrayPush(docIds[term], scoreList)\n        }\n      } else {\n        docIds[''] = []\n        const scoreList = await orama.index.search(context, index, prop, '')\n        safeArrayPush(docIds[''], scoreList)\n      }\n\n      const vals = Object.values(docIds)\n      context.docsIntersection[prop] = prioritizeTokenScores(vals, params?.boost?.[prop] ?? 1, threshold, tokensLength)\n      const uniqueDocs = context.docsIntersection[prop]\n\n      const uniqueDocsLength = uniqueDocs.length\n      for (let i = 0; i < uniqueDocsLength; i++) {\n        const [id, score] = uniqueDocs[i]\n        const prevScore = context.uniqueDocsIDs[id]\n        if (prevScore) {\n          context.uniqueDocsIDs[id] = prevScore + score + 0.5\n        } else {\n          context.uniqueDocsIDs[id] = score\n        }\n      }\n    }\n  } else if (tokens.length === 0 && term) {\n    // This case is hard to handle correctly.\n    // For the time being, if tokenizer returns empty array but the term is not empty,\n    // we returns an empty result set\n    context.uniqueDocsIDs = {}\n  } else {\n    context.uniqueDocsIDs = Object.fromEntries(\n      Object.keys(await orama.documentsStore.getAll(orama.data.docs)).map((k) => [k, 0])\n    )\n  }\n\n  // Get unique doc IDs from uniqueDocsIDs map\n  let uniqueDocsArray = Object.entries(context.uniqueDocsIDs).map(([id, score]) => [+id, score] as TokenScore)\n\n  // If filters are enabled, we need to remove the IDs of the documents that don't match the filters.\n  if (hasFilters) {\n    uniqueDocsArray = intersectFilteredIDs(whereFiltersIDs, uniqueDocsArray)\n  }\n\n  if (params.sortBy) {\n    if (typeof params.sortBy === 'function') {\n      const ids = uniqueDocsArray.map(([id]) => id)\n      const docs = await orama.documentsStore.getMultiple(orama.data.docs, ids)\n      const docsWithIdAndScore: CustomSorterFunctionItem<ResultDocument>[] = docs.map((d, i) => [\n        uniqueDocsArray[i][0],\n        uniqueDocsArray[i][1],\n        d!\n      ])\n      docsWithIdAndScore.sort(params.sortBy)\n      uniqueDocsArray = docsWithIdAndScore.map(([id, score]) => [id, score])\n    } else {\n      uniqueDocsArray = await orama.sorter\n        .sortBy(orama.data.sorting, uniqueDocsArray, params.sortBy)\n        .then((results) =>\n          results.map(([id, score]) => [getInternalDocumentId(orama.internalDocumentIDStore, id), score])\n        )\n    }\n  } else {\n    uniqueDocsArray = uniqueDocsArray.sort(sortTokenScorePredicate)\n  }\n\n  let results\n  if (!isPreflight) {\n    results = await (distinctOn\n      ? fetchDocumentsWithDistinct(orama, uniqueDocsArray, offset, limit, distinctOn)\n      : fetchDocuments(orama, uniqueDocsArray, offset, limit))\n  }\n\n  const searchResult: Results<ResultDocument> = {\n    elapsed: {\n      formatted: '',\n      raw: 0\n    },\n    // We keep the hits array empty if it's a preflight request.\n    hits: [],\n    count: uniqueDocsArray.length\n  }\n\n  if (typeof results !== 'undefined') {\n    searchResult.hits = results.filter(Boolean)\n\n    // Vectors can be very large, so we remove them from the result if not needed\n    if (!includeVectors) {\n      removeVectorsFromHits(searchResult, vectorProperties)\n    }\n  }\n\n  if (shouldCalculateFacets) {\n    // Populate facets if needed\n    const facets = await getFacets(orama, uniqueDocsArray, params.facets!)\n    searchResult.facets = facets\n  }\n\n  if (params.groupBy) {\n    searchResult.groups = await getGroups<T, ResultDocument>(orama, uniqueDocsArray, params.groupBy)\n  }\n\n  if (orama.afterSearch) {\n    await runAfterSearch(orama.afterSearch, orama, params, language, searchResult)\n  }\n\n  // Calculate elapsed time only at the end of the function\n  searchResult.elapsed = (await orama.formatElapsedTime(\n    (await getNanosecondsTime()) - context.timeStart\n  )) as ElapsedTime\n\n  return searchResult\n}\n"],"names":["prioritizeTokenScores","getFacets","intersectFilteredIDs","getGroups","runAfterSearch","runBeforeSearch","getInternalDocumentId","createError","getNanosecondsTime","removeVectorsFromHits","safeArrayPush","sortTokenScorePredicate","createSearchContext","defaultBM25Params","fetchDocuments","fetchDocumentsWithDistinct","fullTextSearch","orama","params","language","timeStart","beforeSearch","relevance","Object","assign","vectorProperties","keys","data","index","vectorIndexes","shouldCalculateFacets","facets","length","limit","offset","term","properties","threshold","distinctOn","includeVectors","isPreflight","preflight","docs","tokens","tokenizer","tokenize","propertiesToSearch","caches","propertiesToSearchWithTypes","getSearchablePropertiesWithTypes","getSearchableProperties","filter","prop","startsWith","includes","join","context","documentsStore","count","hasFilters","where","whereFiltersIDs","searchByWhereClause","tokensLength","indexesLength","i","docIds","indexMap","j","scoreList","search","vals","values","docsIntersection","boost","uniqueDocs","uniqueDocsLength","id","score","prevScore","uniqueDocsIDs","fromEntries","getAll","map","k","uniqueDocsArray","entries","sortBy","ids","getMultiple","docsWithIdAndScore","d","sort","sorter","sorting","then","results","internalDocumentIDStore","searchResult","elapsed","formatted","raw","hits","Boolean","groupBy","groups","afterSearch","formatElapsedTime"],"mappings":"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"}