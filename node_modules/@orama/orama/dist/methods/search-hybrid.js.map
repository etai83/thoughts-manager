{"version":3,"sources":["../../src/methods/search-hybrid.ts"],"sourcesContent":["import type {\n  AnyOrama,\n  TypedDocument,\n  SearchParamsHybrid,\n  Results,\n  TokenScore,\n  Result,\n  HybridWeights\n} from '../types.js'\nimport type { InternalDocumentID } from '../components/internal-document-id-store.js'\nimport { getNanosecondsTime, safeArrayPush, formatNanoseconds, removeVectorsFromHits } from '../utils.js'\nimport { intersectFilteredIDs } from '../components/filters.js'\nimport { prioritizeTokenScores } from '../components/algorithms.js'\nimport { createError } from '../errors.js'\nimport { createSearchContext, defaultBM25Params } from './search.js'\nimport { getFacets } from '../components/facets.js'\nimport { getGroups } from '../components/groups.js'\nimport { findSimilarVectors } from '../components/cosine-similarity.js'\nimport { getInternalDocumentId } from '../components/internal-document-id-store.js'\nimport { fetchDocuments } from './search.js'\nimport { runBeforeSearch, runAfterSearch } from '../components/hooks.js'\n\nexport async function hybridSearch<T extends AnyOrama, ResultDocument = TypedDocument<T>>(\n  orama: T,\n  params: SearchParamsHybrid<T, ResultDocument>,\n  language?: string\n): Promise<Results<ResultDocument>> {\n  const timeStart = await getNanosecondsTime()\n\n  if (orama.beforeSearch) {\n    await runBeforeSearch(orama.beforeSearch, orama, params, language)\n  }\n\n  const { offset = 0, limit = 10, includeVectors = false } = params\n  const shouldCalculateFacets = params.facets && Object.keys(params.facets).length > 0\n\n  const [fullTextIDs, vectorIDs] = await Promise.all([\n    getFullTextSearchIDs(orama, params, language),\n    getVectorSearchIDs(orama, params)\n  ])\n\n  const { index, docs } = orama.data\n  const hybridWeights = params.hybridWeights\n  let uniqueTokenScores = mergeAndRankResults(fullTextIDs, vectorIDs, params.term ?? '', hybridWeights)\n\n  // @todo avoid tokenize twice\n  const tokens = await orama.tokenizer.tokenize(params.term ?? '', language)\n  let propertiesToSearch = orama.caches['propertiesToSearch'] as string[]\n  if (!propertiesToSearch) {\n    const propertiesToSearchWithTypes = await orama.index.getSearchablePropertiesWithTypes(index)\n\n    propertiesToSearch = await orama.index.getSearchableProperties(index)\n    propertiesToSearch = propertiesToSearch.filter((prop: string) =>\n      propertiesToSearchWithTypes[prop].startsWith('string')\n    )\n\n    orama.caches['propertiesToSearch'] = propertiesToSearch\n  }\n\n  if (params.properties && params.properties !== '*') {\n    for (const prop of params.properties) {\n      if (!propertiesToSearch.includes(prop as string)) {\n        throw createError('UNKNOWN_INDEX', prop as string, propertiesToSearch.join(', '))\n      }\n    }\n\n    propertiesToSearch = propertiesToSearch.filter((prop: string) => (params.properties as string[]).includes(prop))\n  }\n\n  // @todo avoid create context twice\n  const context = await createSearchContext(\n    orama.tokenizer,\n    orama.index,\n    orama.documentsStore,\n    language,\n    params,\n    propertiesToSearch,\n    tokens,\n    await orama.documentsStore.count(docs),\n    timeStart\n  )\n\n  const hasFilters = Object.keys(params.where ?? {}).length > 0\n  let whereFiltersIDs: InternalDocumentID[] = []\n\n  if (hasFilters) {\n    whereFiltersIDs = await orama.index.searchByWhereClause(context, index, params.where!)\n    uniqueTokenScores = intersectFilteredIDs(whereFiltersIDs, uniqueTokenScores)\n  }\n\n  let facetsResults: any\n  if (shouldCalculateFacets) {\n    const facets = await getFacets(orama, uniqueTokenScores, params.facets!)\n    facetsResults = facets\n  }\n\n  let groups: any\n  if (params.groupBy) {\n    groups = await getGroups<T, ResultDocument>(orama, uniqueTokenScores, params.groupBy)\n  }\n\n  const results = (await fetchDocuments(orama, uniqueTokenScores, offset, limit)).filter(Boolean)\n\n  if (orama.afterSearch) {\n    await runAfterSearch(orama.afterSearch, orama, params, language, results as any)\n  }\n\n  const timeEnd = await getNanosecondsTime()\n\n  const returningResults = {\n    count: uniqueTokenScores.length,\n    elapsed: {\n      raw: Number(timeEnd - timeStart),\n      formatted: await formatNanoseconds(timeEnd - timeStart)\n    },\n    hits: results as Result<ResultDocument>[],\n    ...(facetsResults ? { facets: facetsResults } : {}),\n    ...(groups ? { groups } : {})\n  }\n\n  if (!includeVectors) {\n    const vectorProperties = Object.keys(orama.data.index.vectorIndexes)\n    removeVectorsFromHits(returningResults, vectorProperties)\n  }\n\n  return returningResults\n}\n\nasync function getFullTextSearchIDs<T extends AnyOrama, ResultDocument = TypedDocument<T>>(\n  orama: T,\n  params: SearchParamsHybrid<T, ResultDocument>,\n  language?: string\n): Promise<TokenScore[]> {\n  const timeStart = await getNanosecondsTime()\n  params.relevance = Object.assign(defaultBM25Params, params.relevance ?? {})\n\n  const { term = '', properties, threshold = 0 } = params\n\n  const { index, docs } = orama.data\n  const tokens = await orama.tokenizer.tokenize(term, language)\n\n  // Get searchable string properties\n  let propertiesToSearch = orama.caches['propertiesToSearch'] as string[]\n  if (!propertiesToSearch) {\n    const propertiesToSearchWithTypes = await orama.index.getSearchablePropertiesWithTypes(index)\n\n    propertiesToSearch = await orama.index.getSearchableProperties(index)\n    propertiesToSearch = propertiesToSearch.filter((prop: string) =>\n      propertiesToSearchWithTypes[prop].startsWith('string')\n    )\n\n    orama.caches['propertiesToSearch'] = propertiesToSearch\n  }\n\n  if (properties && properties !== '*') {\n    const propertiesToSearchSet = new Set(propertiesToSearch)\n    const propertiesSet = new Set(properties as string[])\n\n    for (const prop of properties) {\n      if (!propertiesToSearchSet.has(prop as string)) {\n        throw createError('UNKNOWN_INDEX', prop as string, propertiesToSearch.join(', '))\n      }\n    }\n\n    propertiesToSearch = propertiesToSearch.filter((prop: string) => propertiesSet.has(prop))\n  }\n\n  // Create the search context and the results\n  const context = await createSearchContext(\n    orama.tokenizer,\n    orama.index,\n    orama.documentsStore,\n    language,\n    params,\n    propertiesToSearch,\n    tokens,\n    await orama.documentsStore.count(docs),\n    timeStart\n  )\n\n  const tokensLength = tokens.length\n\n  if (tokensLength || (properties && properties.length > 0)) {\n    // Now it's time to loop over all the indices and get the documents IDs for every single term\n    const indexesLength = propertiesToSearch.length\n    for (let i = 0; i < indexesLength; i++) {\n      const prop = propertiesToSearch[i]\n\n      if (tokensLength !== 0) {\n        for (let j = 0; j < tokensLength; j++) {\n          const term = tokens[j]\n\n          // Lookup\n          const scoreList = await orama.index.search(context, index, prop, term)\n\n          safeArrayPush(context.indexMap[prop][term], scoreList)\n        }\n      } else {\n        const indexMapContent = []\n        context.indexMap[prop][''] = indexMapContent\n        const scoreList = await orama.index.search(context, index, prop, '')\n        safeArrayPush(indexMapContent, scoreList)\n      }\n\n      const docIds = context.indexMap[prop]\n      const vals = Object.values(docIds)\n      context.docsIntersection[prop] = prioritizeTokenScores(vals, params?.boost?.[prop] ?? 1, threshold, tokensLength)\n      const uniqueDocs = context.docsIntersection[prop]\n\n      const uniqueDocsLength = uniqueDocs.length\n      for (let i = 0; i < uniqueDocsLength; i++) {\n        const [id, score] = uniqueDocs[i]\n        const prevScore = context.uniqueDocsIDs[id]\n        context.uniqueDocsIDs[id] = prevScore ? prevScore + score + 0.5 : score\n      }\n    }\n  } else if (tokens.length === 0 && term) {\n    // This case is hard to handle correctly.\n    // For the time being, if tokenizer returns empty array but the term is not empty,\n    // we returns an empty result set\n    context.uniqueDocsIDs = {}\n  } else {\n    context.uniqueDocsIDs = Object.fromEntries(\n      Object.keys(await orama.documentsStore.getAll(orama.data.docs)).map((k) => [k, 0])\n    )\n  }\n\n  const uniqueIDs = Object.entries(context.uniqueDocsIDs)\n    .map(([id, score]) => [+id, score] as TokenScore)\n    .sort((a, b) => b[1] - a[1])\n\n  return minMaxScoreNormalization(uniqueIDs)\n}\n\nexport async function getVectorSearchIDs<T extends AnyOrama, ResultDocument = TypedDocument<T>>(\n  orama: T,\n  params: SearchParamsHybrid<T, ResultDocument>\n): Promise<TokenScore[]> {\n  const vector = params.vector\n  // eslint-disable-next-line @typescript-eslint/no-non-null-asserted-optional-chain\n  const vectorIndex = orama.data.index.vectorIndexes[vector?.property!]\n  const vectorSize = vectorIndex.size\n  const vectors = vectorIndex.vectors\n\n  if (vector && (!vector.value || !vector.property)) {\n    throw createError('INVALID_VECTOR_INPUT', Object.keys(vector).join(', '))\n  }\n\n  if (vector!.value.length !== vectorSize) {\n    throw createError('INVALID_INPUT_VECTOR', vector!.property, vectorSize, vector!.value.length)\n  }\n\n  if (!(vector instanceof Float32Array)) {\n    vector!.value = new Float32Array(vector!.value)\n  }\n\n  const uniqueIDs = findSimilarVectors(vector!.value as Float32Array, vectors, vectorSize, params.similarity).map(\n    ([id, score]) => [getInternalDocumentId(orama.internalDocumentIDStore, id), score]\n  ) as TokenScore[]\n\n  return minMaxScoreNormalization(uniqueIDs)\n}\n\nfunction extractScore([, score]: TokenScore) {\n  return score\n}\n\nfunction minMaxScoreNormalization(results: TokenScore[]): TokenScore[] {\n  // In this case I disabled the `prefer-spread` rule because spread seems to be slower\n  // eslint-disable-next-line prefer-spread\n  const maxScore = Math.max.apply(Math, results.map(extractScore))\n  return results.map(([id, score]) => [id, score / maxScore] as TokenScore)\n}\n\nfunction normalizeScore(score: number, maxScore: number) {\n  return score / maxScore\n}\n\nfunction hybridScoreBuilder(textWeight: number, vectorWeight: number) {\n  return (textScore: number, vectorScore: number) => textScore * textWeight + vectorScore * vectorWeight\n}\n\nfunction mergeAndRankResults(\n  textResults: TokenScore[],\n  vectorResults: TokenScore[],\n  query: string,\n  hybridWeights: HybridWeights | undefined\n) {\n  // eslint-disable-next-line prefer-spread\n  const maxTextScore = Math.max.apply(Math, textResults.map(extractScore))\n  // eslint-disable-next-line prefer-spread\n  const maxVectorScore = Math.max.apply(Math, vectorResults.map(extractScore))\n  const hasHybridWeights = hybridWeights && hybridWeights.text && hybridWeights.vector\n\n  const { text: textWeight, vector: vectorWeight } = hasHybridWeights ? hybridWeights : getQueryWeights(query)\n  const mergedResults = new Map()\n\n  const textResultsLength = textResults.length\n  const hybridScore = hybridScoreBuilder(textWeight, vectorWeight)\n  for (let i = 0; i < textResultsLength; i++) {\n    const [id, score] = textResults[i]\n    const normalizedScore = normalizeScore(score, maxTextScore)\n    const hybridScoreValue = hybridScore(normalizedScore, 0)\n    mergedResults.set(id, hybridScoreValue)\n  }\n\n  const vectorResultsLength = vectorResults.length\n  for (let i = 0; i < vectorResultsLength; i++) {\n    const [resultId, score] = vectorResults[i]\n    const normalizedScore = normalizeScore(score, maxVectorScore)\n    const existingRes = mergedResults.get(resultId) ?? 0\n    mergedResults.set(resultId, existingRes + hybridScore(0, normalizedScore))\n  }\n\n  return [...mergedResults].sort((a, b) => b[1] - a[1])\n}\n\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nfunction getQueryWeights(query: string): HybridWeights {\n  // In the next versions of Orama, we will ship a plugin containing a ML model to adjust the weights\n  // based on whether the query is keyword-focused, conceptual, etc.\n  // For now, we just return a fixed value.\n  return {\n    text: 0.5,\n    vector: 0.5\n  }\n}\n"],"names":["getNanosecondsTime","safeArrayPush","formatNanoseconds","removeVectorsFromHits","intersectFilteredIDs","prioritizeTokenScores","createError","createSearchContext","defaultBM25Params","getFacets","getGroups","findSimilarVectors","getInternalDocumentId","fetchDocuments","runBeforeSearch","runAfterSearch","hybridSearch","orama","params","language","timeStart","beforeSearch","offset","limit","includeVectors","shouldCalculateFacets","facets","Object","keys","length","fullTextIDs","vectorIDs","Promise","all","getFullTextSearchIDs","getVectorSearchIDs","index","docs","data","hybridWeights","uniqueTokenScores","mergeAndRankResults","term","tokens","tokenizer","tokenize","propertiesToSearch","caches","propertiesToSearchWithTypes","getSearchablePropertiesWithTypes","getSearchableProperties","filter","prop","startsWith","properties","includes","join","context","documentsStore","count","hasFilters","where","whereFiltersIDs","searchByWhereClause","facetsResults","groups","groupBy","results","Boolean","afterSearch","timeEnd","returningResults","elapsed","raw","Number","formatted","hits","vectorProperties","vectorIndexes","relevance","assign","threshold","propertiesToSearchSet","Set","propertiesSet","has","tokensLength","indexesLength","i","j","scoreList","search","indexMap","indexMapContent","docIds","vals","values","docsIntersection","boost","uniqueDocs","uniqueDocsLength","id","score","prevScore","uniqueDocsIDs","fromEntries","getAll","map","k","uniqueIDs","entries","sort","a","b","minMaxScoreNormalization","vector","vectorIndex","property","vectorSize","size","vectors","value","Float32Array","similarity","internalDocumentIDStore","extractScore","maxScore","Math","max","apply","normalizeScore","hybridScoreBuilder","textWeight","vectorWeight","textScore","vectorScore","textResults","vectorResults","query","maxTextScore","maxVectorScore","hasHybridWeights","text","getQueryWeights","mergedResults","Map","textResultsLength","hybridScore","normalizedScore","hybridScoreValue","set","vectorResultsLength","resultId","existingRes","get"],"mappings":"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"}