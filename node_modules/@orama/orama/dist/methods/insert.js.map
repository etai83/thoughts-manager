{"version":3,"sources":["../../src/methods/insert.ts"],"sourcesContent":["import { isArrayType, isGeoPointType, isVectorType } from '../components.js'\nimport { runMultipleHook, runSingleHook } from '../components/hooks.js'\nimport { trackInsertion } from '../components/sync-blocking-checker.js'\nimport { createError } from '../errors.js'\nimport { Point } from '../trees/bkd.js'\nimport { AnyOrama, PartialSchemaDeep, SortValue, TypedDocument } from '../types.js'\n\nexport type InsertOptions = {\n  avlRebalanceThreshold?: number\n}\n\nexport async function insert<T extends AnyOrama>(\n  orama: T,\n  doc: PartialSchemaDeep<TypedDocument<T>>,\n  language?: string,\n  skipHooks?: boolean,\n  options?: InsertOptions\n): Promise<string> {\n  const errorProperty = await orama.validateSchema(doc, orama.schema)\n  if (errorProperty) {\n    throw createError('SCHEMA_VALIDATION_FAILURE', errorProperty)\n  }\n\n  return innerInsert(orama, doc, language, skipHooks, options)\n}\n\nconst ENUM_TYPE = new Set(['enum', 'enum[]'])\nconst STRING_NUMBER_TYPE = new Set(['string', 'number'])\n\nasync function innerInsert<T extends AnyOrama>(\n  orama: T,\n  doc: PartialSchemaDeep<TypedDocument<T>>,\n  language?: string,\n  skipHooks?: boolean,\n  options?: InsertOptions\n): Promise<string> {\n  const { index, docs } = orama.data\n\n  const id = await orama.getDocumentIndexId(doc)\n\n  if (typeof id !== 'string') {\n    throw createError('DOCUMENT_ID_MUST_BE_STRING', typeof id)\n  }\n\n  if (!(await orama.documentsStore.store(docs, id, doc))) {\n    throw createError('DOCUMENT_ALREADY_EXISTS', id)\n  }\n\n  const docsCount = await orama.documentsStore.count(docs)\n\n  if (!skipHooks) {\n    await runSingleHook(orama.beforeInsert, orama, id, doc as TypedDocument<T>)\n  }\n\n  const indexableProperties = await orama.index.getSearchableProperties(index)\n  const indexablePropertiesWithTypes = await orama.index.getSearchablePropertiesWithTypes(index)\n  const indexableValues = await orama.getDocumentProperties(doc, indexableProperties)\n\n  for (const [key, value] of Object.entries(indexableValues)) {\n    if (typeof value === 'undefined') {\n      continue\n    }\n\n    const actualType = typeof value\n    const expectedType = indexablePropertiesWithTypes[key]\n\n    if (\n      isGeoPointType(expectedType) &&\n      typeof value === 'object' &&\n      typeof (value as Point).lon === 'number' &&\n      typeof (value as Point).lat === 'number'\n    ) {\n      continue\n    }\n\n    if (isVectorType(expectedType) && Array.isArray(value)) {\n      // @todo: Validate vector type. It should be of a given length and contain only floats.\n      continue\n    }\n\n    if (isArrayType(expectedType) && Array.isArray(value)) {\n      continue\n    }\n\n    if (ENUM_TYPE.has(expectedType) && STRING_NUMBER_TYPE.has(actualType)) {\n      continue\n    }\n\n    if (actualType !== expectedType) {\n      throw createError('INVALID_DOCUMENT_PROPERTY', key, expectedType, actualType)\n    }\n  }\n\n  for (const prop of indexableProperties) {\n    const value = indexableValues[prop]\n    if (typeof value === 'undefined') {\n      continue\n    }\n\n    const expectedType = indexablePropertiesWithTypes[prop]\n    await orama.index.beforeInsert?.(\n      orama.data.index,\n      prop,\n      id,\n      value,\n      expectedType,\n      language,\n      orama.tokenizer,\n      docsCount\n    )\n    await orama.index.insert(\n      orama.index,\n      orama.data.index,\n      prop,\n      id,\n      value,\n      expectedType,\n      language,\n      orama.tokenizer,\n      docsCount,\n      options\n    )\n    await orama.index.afterInsert?.(\n      orama.data.index,\n      prop,\n      id,\n      value,\n      expectedType,\n      language,\n      orama.tokenizer,\n      docsCount\n    )\n  }\n\n  const sortableProperties = await orama.sorter.getSortableProperties(orama.data.sorting)\n  const sortablePropertiesWithTypes = await orama.sorter.getSortablePropertiesWithTypes(orama.data.sorting)\n  const sortableValues = await orama.getDocumentProperties(doc, sortableProperties)\n  for (const prop of sortableProperties) {\n    const value = sortableValues[prop] as SortValue\n    if (typeof value === 'undefined') {\n      continue\n    }\n\n    const expectedType = sortablePropertiesWithTypes[prop]\n\n    await orama.sorter.insert(orama.data.sorting, prop, id, value, expectedType, language)\n  }\n\n  if (!skipHooks) {\n    await runSingleHook(orama.afterInsert, orama, id, doc as TypedDocument<T>)\n  }\n\n  trackInsertion(orama)\n\n  return id\n}\n\nexport async function insertMultiple<T extends AnyOrama>(\n  orama: T,\n  docs: PartialSchemaDeep<TypedDocument<T>>[],\n  batchSize?: number,\n  language?: string,\n  skipHooks?: boolean,\n  timeout?: number\n): Promise<string[]> {\n  if (!skipHooks) {\n    await runMultipleHook(orama.beforeInsertMultiple, orama, docs as TypedDocument<T>[])\n  }\n\n  // Validate all documents before the insertion\n  const docsLength = docs.length\n  const oramaSchema = orama.schema\n  for (let i = 0; i < docsLength; i++) {\n    const errorProperty = await orama.validateSchema(docs[i], oramaSchema)\n    if (errorProperty) {\n      throw createError('SCHEMA_VALIDATION_FAILURE', errorProperty)\n    }\n  }\n\n  return innerInsertMultiple(orama, docs, batchSize, language, skipHooks, timeout)\n}\n\nexport async function innerInsertMultiple<T extends AnyOrama>(\n  orama: T,\n  docs: PartialSchemaDeep<TypedDocument<T>>[],\n  batchSize?: number,\n  language?: string,\n  skipHooks?: boolean,\n  timeout?: number\n): Promise<string[]> {\n  if (!batchSize) {\n    batchSize = 1000\n  }\n\n  timeout ??= 0\n\n  const ids: string[] = []\n  await new Promise<void>((resolve, reject) => {\n    let i = 0\n    async function _insertMultiple() {\n      const batch = docs.slice(i * batchSize!, ++i * batchSize!)\n\n      if (!batch.length) {\n        return resolve()\n      }\n\n      for (const doc of batch) {\n        try {\n          const options = { avlRebalanceThreshold: batch.length }\n          const id = await insert(orama, doc, language, skipHooks, options)\n          ids.push(id)\n        } catch (err) {\n          reject(err)\n        }\n      }\n\n      setTimeout(_insertMultiple, timeout)\n    }\n\n    setTimeout(_insertMultiple, timeout)\n  })\n\n  if (!skipHooks) {\n    await runMultipleHook(orama.afterInsertMultiple, orama, docs as TypedDocument<T>[])\n  }\n\n  return ids\n}\n"],"names":["isArrayType","isGeoPointType","isVectorType","runMultipleHook","runSingleHook","trackInsertion","createError","insert","orama","doc","language","skipHooks","options","errorProperty","validateSchema","schema","innerInsert","ENUM_TYPE","Set","STRING_NUMBER_TYPE","index","docs","data","id","getDocumentIndexId","documentsStore","store","docsCount","count","beforeInsert","indexableProperties","getSearchableProperties","indexablePropertiesWithTypes","getSearchablePropertiesWithTypes","indexableValues","getDocumentProperties","key","value","Object","entries","actualType","expectedType","lon","lat","Array","isArray","has","prop","tokenizer","afterInsert","sortableProperties","sorter","getSortableProperties","sorting","sortablePropertiesWithTypes","getSortablePropertiesWithTypes","sortableValues","insertMultiple","batchSize","timeout","beforeInsertMultiple","docsLength","length","oramaSchema","i","innerInsertMultiple","ids","Promise","resolve","reject","_insertMultiple","batch","slice","avlRebalanceThreshold","push","err","setTimeout","afterInsertMultiple"],"mappings":"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"}